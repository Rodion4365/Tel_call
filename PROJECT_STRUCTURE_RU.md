# üì± Tel Call - –ü–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø—Ä–æ–µ–∫—Ç–∞

> **WebRTC –≤–∏–¥–µ–æ/–∞—É–¥–∏–æ –∑–≤–æ–Ω–∫–∏ –≤ Telegram Mini App**
> –î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è: 2025-12-13 | –í–µ—Ä—Å–∏—è: 2.0

---

## üìñ –û–≥–ª–∞–≤–ª–µ–Ω–∏–µ

1. [–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ](#–∫—Ä–∞—Ç–∫–æ–µ-–æ–ø–∏—Å–∞–Ω–∏–µ)
2. [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞](#–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞-–ø—Ä–æ–µ–∫—Ç–∞)
3. [–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π](#—Å—Ç—Ä—É–∫—Ç—É—Ä–∞-–¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π)
4. [–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫](#—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π-—Å—Ç–µ–∫)
5. [–û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã](#–æ—Å–Ω–æ–≤–Ω—ã–µ-–∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã)
6. [–ö–ª—é—á–µ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏](#–∫–ª—é—á–µ–≤—ã–µ-—Ñ—É–Ω–∫—Ü–∏–∏)
7. [–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö](#–±–∞–∑–∞-–¥–∞–Ω–Ω—ã—Ö)
8. [API Endpoints](#api-endpoints)
9. [WebRTC & –°–∏–≥–Ω–∞–ª–∏–∑–∞—Ü–∏—è](#webrtc--—Å–∏–≥–Ω–∞–ª–∏–∑–∞—Ü–∏—è)
10. [–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å](#–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å)
11. [–ì–¥–µ —á—Ç–æ –ø—Ä–∞–≤–∏—Ç—å](#–≥–¥–µ-—á—Ç–æ-–ø—Ä–∞–≤–∏—Ç—å)
12. [–†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ](#—Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ)

---

## üìù –ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ

**Tel Call** - —ç—Ç–æ –ø–æ–ª–Ω–æ—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –≤–∏–¥–µ–æ/–∞—É–¥–∏–æ –∑–≤–æ–Ω–∫–æ–≤, –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –≤ Telegram –∫–∞–∫ Mini App. –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç WebRTC –¥–ª—è peer-to-peer —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π —Å mesh-—Ç–æ–ø–æ–ª–æ–≥–∏–µ–π.

### –ö–ª—é—á–µ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:
- ‚úÖ –ê—É–¥–∏–æ/–≤–∏–¥–µ–æ –∑–≤–æ–Ω–∫–∏ —á–µ—Ä–µ–∑ WebRTC
- ‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ Telegram (–±–µ–∑ –ø–∞—Ä–æ–ª—è!)
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –¥—Ä—É–∑–µ–π
- ‚úÖ –ü—Ä—è–º—ã–µ –∑–≤–æ–Ω–∫–∏ –¥—Ä—É–∑—å—è–º —Å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º–∏
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ STUN/TURN —Å–µ—Ä–≤–µ—Ä–æ–≤ (—Ä–∞–±–æ—Ç–∞–µ—Ç –∑–∞ NAT)
- ‚úÖ –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π UI –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
- ‚úÖ –ú—É–ª—å—Ç–∏—è–∑—ã—á–Ω–æ—Å—Ç—å (—Ä—É—Å—Å–∫–∏–π/–∞–Ω–≥–ª–∏–π—Å–∫–∏–π)
- ‚úÖ –í—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è –∑–∞—â–∏—Ç–∞ –æ—Ç DDoS (rate limiting)

---

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                      Telegram App                           ‚îÇ
‚îÇ  (–æ—Ç–∫—Ä—ã–≤–∞–µ—Ç Mini App –≤ WebView/iframe)                      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                     ‚îÇ
                     ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                  Frontend (React + Vite)                    ‚îÇ
‚îÇ  ‚Ä¢ Telegram SDK –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è                                  ‚îÇ
‚îÇ  ‚Ä¢ WebRTC –∫–ª–∏–µ–Ω—Ç (PeerConnection)                           ‚îÇ
‚îÇ  ‚Ä¢ UI/UX –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã                                         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
             ‚îÇ                        ‚îÇ
             ‚îÇ HTTPS REST             ‚îÇ WebSocket (WSS)
             ‚îÇ                        ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ              Backend (FastAPI + Python)                     ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                ‚îÇ
‚îÇ  ‚îÇ  HTTP API        ‚îÇ  ‚îÇ  WebSocket       ‚îÇ                ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ /auth         ‚îÇ  ‚îÇ  Signaling       ‚îÇ                ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ /calls        ‚îÇ  ‚îÇ  ‚Ä¢ Offer/Answer  ‚îÇ                ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ /friends      ‚îÇ  ‚îÇ  ‚Ä¢ ICE exchange  ‚îÇ                ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                ‚îÇ
‚îÇ  ‚îÇ  Auth Service    ‚îÇ  ‚îÇ  CallRoom        ‚îÇ                ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ JWT tokens    ‚îÇ  ‚îÇ  Manager         ‚îÇ                ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ Telegram      ‚îÇ  ‚îÇ  (in-memory)     ‚îÇ                ‚îÇ
‚îÇ  ‚îÇ    validation    ‚îÇ  ‚îÇ                  ‚îÇ                ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
             ‚îÇ
             ‚îÇ SQL (asyncpg)
             ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                PostgreSQL Database                          ‚îÇ
‚îÇ  ‚Ä¢ users, calls, participants, friend_links, call_stats     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                   Infrastructure                            ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê          ‚îÇ
‚îÇ  ‚îÇ  Traefik   ‚îÇ  ‚îÇ   Coturn   ‚îÇ  ‚îÇ  Telegram    ‚îÇ          ‚îÇ
‚îÇ  ‚îÇ  (Proxy)   ‚îÇ  ‚îÇ   (TURN)   ‚îÇ  ‚îÇ  Bot API     ‚îÇ          ‚îÇ
‚îÇ  ‚îÇ  HTTPS/WSS ‚îÇ  ‚îÇ  NAT       ‚îÇ  ‚îÇ  (Push       ‚îÇ          ‚îÇ
‚îÇ  ‚îÇ            ‚îÇ  ‚îÇ  Traversal ‚îÇ  ‚îÇ  Notif.)     ‚îÇ          ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

                WebRTC Media (P2P)
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  User A  ‚îÇ         (direct)                ‚îÇ  User B  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                                 ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**–í–∞–∂–Ω–æ:**
- HTTP/WebSocket –¥–ª—è —Å–∏–≥–Ω–∞–ª–∏–∑–∞—Ü–∏–∏ (–∫–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏—è)
- WebRTC –¥–ª—è –º–µ–¥–∏–∞-–ø–æ—Ç–æ–∫–æ–≤ (–Ω–∞–ø—Ä—è–º—É—é –º–µ–∂–¥—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏)
- TURN —Å–µ—Ä–≤–µ—Ä –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¢–û–õ–¨–ö–û –µ—Å–ª–∏ –ø—Ä—è–º–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ

---

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π

```
Tel_call/
‚îÇ
‚îú‚îÄ‚îÄ backend/                      # Python FastAPI –±—ç–∫–µ–Ω–¥
‚îÇ   ‚îú‚îÄ‚îÄ alembic/                  # –ú–∏–≥—Ä–∞—Ü–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ versions/             # 8 –º–∏–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
‚îÇ   ‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ api/                  # HTTP & WebSocket endpoints
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth.py           # Telegram OAuth, JWT
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ calls.py          # CRUD –¥–ª—è –∑–≤–æ–Ω–∫–æ–≤
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ signaling.py      # WebSocket signaling
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ friends.py        # –°–ø–∏—Å–æ–∫ –¥—Ä—É–∑–µ–π
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ call_stats.py     # –ú–µ—Ç—Ä–∏–∫–∏ –∫–∞—á–µ—Å—Ç–≤–∞ –∑–≤–æ–Ω–∫–æ–≤
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ config.py         # WebRTC config (STUN/TURN)
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ telegram_webhook.py # Telegram bot webhook
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ config/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ settings.py       # Env variables, –∫–æ–Ω—Ñ–∏–≥
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ database.py       # SQLAlchemy async setup
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ logging.py        # –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ª–æ–≥–∏
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ models/               # SQLAlchemy ORM –º–æ–¥–µ–ª–∏
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ user.py           # –¢–∞–±–ª–∏—Ü–∞ users
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ call.py           # –¢–∞–±–ª–∏—Ü–∞ calls
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ participant.py    # –¢–∞–±–ª–∏—Ü–∞ participants
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ friend_link.py    # –¢–∞–±–ª–∏—Ü–∞ friend_links
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ call_stats.py     # –¢–∞–±–ª–∏—Ü–∞ call_stats
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ services/             # –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth.py           # JWT, Telegram validation
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ signaling.py      # CallRoom, CallRoomManager
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ telegram_bot.py   # –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ turn_healthcheck.py # –ü—Ä–æ–≤–µ—Ä–∫–∞ TURN —Å–µ—Ä–≤–µ—Ä–æ–≤
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ main.py               # FastAPI app entrypoint
‚îÇ   ‚îú‚îÄ‚îÄ tests/                    # Unit & integration —Ç–µ—Å—Ç—ã
‚îÇ   ‚îú‚îÄ‚îÄ .env.example              # –ü—Ä–∏–º–µ—Ä –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ requirements.txt          # Python –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
‚îÇ   ‚îî‚îÄ‚îÄ Dockerfile                # Backend container
‚îÇ
‚îú‚îÄ‚îÄ frontend/                     # React + TypeScript
‚îÇ   ‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ assets/               # –ö–∞—Ä—Ç–∏–Ω–∫–∏, SVG, –∑–≤—É–∫–∏
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ components/           # –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ui/               # UI kit (Switch, –∫–Ω–æ–ø–∫–∏)
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ConnectionBanner.tsx  # –°—Ç–∞—Ç—É—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ MobileFrame.tsx   # –û–±–µ—Ä—Ç–∫–∞ –¥–ª—è –º–æ–±–∏–ª—å–Ω–æ–≥–æ –≤–∏–¥–∞
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ TopBar.tsx        # –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ contexts/             # React Context API
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ AuthContext.tsx   # –°–æ—Å—Ç–æ—è–Ω–∏–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ NavigationContext.tsx # –ù–∞–≤–∏–≥–∞—Ü–∏—è
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ WebAppConnectionContext.tsx # Telegram WebApp
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ hooks/                # Custom React hooks
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ useTelegramWebApp.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ useTelegramBackButton.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ useTelegramTheme.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ useWebSocketToken.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ i18n/                 # –ò–Ω—Ç–µ—Ä–Ω–∞—Ü–∏–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ i18n.ts           # i18next setup
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ locales/
‚îÇ   ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ en.json       # –ê–Ω–≥–ª–∏–π—Å–∫–∏–π
‚îÇ   ‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ ru.json       # –†—É—Å—Å–∫–∏–π
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ pages/                # –°—Ç—Ä–∞–Ω–∏—Ü—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ MainPage.tsx      # –ì–ª–∞–≤–Ω–∞—è (—Å–æ–∑–¥–∞—Ç—å/–ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è)
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ CallPage.tsx      # –ê–∫—Ç–∏–≤–Ω—ã–π –∑–≤–æ–Ω–æ–∫ (1737 —Å—Ç—Ä–æ–∫!)
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ CallCreated.tsx   # –ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –∑–≤–æ–Ω–∫–∞
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ CallEndedPage.tsx # –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∑–≤–æ–Ω–∫–∞
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ JoinCallPage.tsx  # –í–≤–æ–¥ –∫–æ–¥–∞ –∑–≤–æ–Ω–∫–∞
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ FriendsPage.tsx   # –°–ø–∏—Å–æ–∫ –¥—Ä—É–∑–µ–π
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ SettingsPage.tsx  # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ (—è–∑—ã–∫)
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ TermsPage.tsx     # –£—Å–ª–æ–≤–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ services/             # API –∫–ª–∏–µ–Ω—Ç—ã
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ apiClient.ts      # –ë–∞–∑–æ–≤—ã–π HTTP –∫–ª–∏–µ–Ω—Ç
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth.ts           # Auth API
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ calls.ts          # Calls API
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ friends.ts        # Friends API
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ webrtc.ts         # WebRTC config API
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ telegram.ts       # Telegram WebApp SDK
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ types/                # TypeScript —Ç–∏–ø—ã
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ utils/                # –£—Ç–∏–ª–∏—Ç—ã
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ webrtc/               # WebRTC –∫–ª–∏–µ–Ω—Ç (legacy)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ App.tsx               # Root –∫–æ–º–ø–æ–Ω–µ–Ω—Ç
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ main.tsx              # React entrypoint
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ styles.css            # Global styles
‚îÇ   ‚îú‚îÄ‚îÄ public/                   # –°—Ç–∞—Ç–∏–∫–∞
‚îÇ   ‚îú‚îÄ‚îÄ package.json              # NPM –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
‚îÇ   ‚îú‚îÄ‚îÄ vite.config.ts            # Vite –∫–æ–Ω—Ñ–∏–≥
‚îÇ   ‚îî‚îÄ‚îÄ Dockerfile                # Frontend container
‚îÇ
‚îú‚îÄ‚îÄ infra/                        # Infrastructure as Code
‚îÇ   ‚îú‚îÄ‚îÄ docker-compose.yml        # –û—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏—è —Å–µ—Ä–≤–∏—Å–æ–≤
‚îÇ   ‚îú‚îÄ‚îÄ .env.example              # –ò–Ω—Ñ—Ä–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
‚îÇ   ‚îú‚îÄ‚îÄ traefik/                  # Reverse proxy
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ dynamic/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ middlewares.yml   # Security headers
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ certs/                # TLS —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã
‚îÇ   ‚îî‚îÄ‚îÄ turn/                     # TURN —Å–µ—Ä–≤–µ—Ä
‚îÇ       ‚îî‚îÄ‚îÄ certs/                # TURN TLS —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã
‚îÇ
‚îú‚îÄ‚îÄ SECURITY_AUDIT_REPORT.md      # –û—Ç—á–µ—Ç –ø–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
‚îú‚îÄ‚îÄ PROJECT_STRUCTURE_RU.md       # –≠—Ç–æ—Ç —Ñ–∞–π–ª
‚îî‚îÄ‚îÄ README.md                     # –û—Å–Ω–æ–≤–Ω–æ–π README
```

---

## üõ†Ô∏è –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫

### Backend
| –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è | –í–µ—Ä—Å–∏—è | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|-----------|--------|-----------|
| **Python** | 3.12+ | –Ø–∑—ã–∫ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è |
| **FastAPI** | 0.115+ | –í–µ–±-—Ñ—Ä–µ–π–º–≤–æ—Ä–∫ (async) |
| **SQLAlchemy** | 2.0+ | ORM (async) |
| **Alembic** | 1.14+ | –ú–∏–≥—Ä–∞—Ü–∏–∏ –ë–î |
| **PostgreSQL** | 15+ | –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö |
| **aiogram** | 3.15+ | Telegram Bot API |
| **PyJWT** | 2.10+ | JWT —Ç–æ–∫–µ–Ω—ã |
| **SlowAPI** | 0.1+ | Rate limiting |
| **Uvicorn** | 0.34+ | ASGI —Å–µ—Ä–≤–µ—Ä |

### Frontend
| –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è | –í–µ—Ä—Å–∏—è | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|-----------|--------|-----------|
| **React** | 18.3+ | UI –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ |
| **TypeScript** | 5.7+ | –¢–∏–ø–∏–∑–∞—Ü–∏—è |
| **Vite** | 6.0+ | Bundler & dev server |
| **TailwindCSS** | 4.0+ | CSS —Ñ—Ä–µ–π–º–≤–æ—Ä–∫ |
| **React Router** | 7.1+ | –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è |
| **i18next** | 24.0+ | i18n |
| **Framer Motion** | 11.15+ | –ê–Ω–∏–º–∞—Ü–∏–∏ |

### Infrastructure
| –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è | –í–µ—Ä—Å–∏—è | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|-----------|--------|-----------|
| **Docker** | 24+ | –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏–∑–∞—Ü–∏—è |
| **Traefik** | 3.0+ | Reverse proxy + HTTPS |
| **Coturn** | 4.6.3 | TURN —Å–µ—Ä–≤–µ—Ä |
| **Nginx** | (–¥–ª—è –ø—Ä–æ–¥–∞) | Frontend —Å–µ—Ä–≤–µ—Ä |

---

## üß© –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

### 1. –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ (backend/app/services/auth.py)

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:**
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–æ–¥–ø–∏—Å—å Telegram initData (HMAC-SHA256)
- –°–æ–∑–¥–∞–µ—Ç/–æ–±–Ω–æ–≤–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ë–î
- –í—ã–¥–∞–µ—Ç JWT —Ç–æ–∫–µ–Ω (30 –¥–Ω–µ–π)
- –°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ç–æ–∫–µ–Ω –≤ httpOnly cookie (–∑–∞—â–∏—Ç–∞ –æ—Ç XSS)

**–ü—Ä–æ—Ü–µ—Å—Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:**
```
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç Telegram Mini App
2. Telegram –ø–µ—Ä–µ–¥–∞–µ—Ç initData (—Å–æ–¥–µ—Ä–∂–∏—Ç user info + –ø–æ–¥–ø–∏—Å—å)
3. Frontend –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç initData ‚Üí POST /auth/telegram
4. Backend:
   a. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–æ–¥–ø–∏—Å—å –∏—Å–ø–æ–ª—å–∑—É—è BOT_TOKEN
   b. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç auth_date (–Ω–µ —Å—Ç–∞—Ä—à–µ 24 —á–∞—Å–æ–≤)
   c. –°–æ–∑–¥–∞–µ—Ç/–æ–±–Ω–æ–≤–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   d. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç JWT —Ç–æ–∫–µ–Ω
   e. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç httpOnly cookie
5. Frontend –ø–æ–ª—É—á–∞–µ—Ç —Ç–æ–∫–µ–Ω (—Ç–∞–∫–∂–µ –≤ body –¥–ª—è fallback)
6. –í—Å–µ –ø–æ—Å–ª–µ–¥—É—é—â–∏–µ –∑–∞–ø—Ä–æ—Å—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã
```

**–ì–¥–µ –ø—Ä–∞–≤–∏—Ç—å:**
- **–í—Ä–µ–º—è –∂–∏–∑–Ω–∏ —Ç–æ–∫–µ–Ω–∞:** `backend/app/config/settings.py:30-34` (`ACCESS_TOKEN_EXPIRE_MINUTES`)
- **–ê–ª–≥–æ—Ä–∏—Ç–º –ø–æ–¥–ø–∏—Å–∏:** `backend/app/services/auth.py:33-49` (—Ñ—É–Ω–∫—Ü–∏—è `_validate_signature`)
- **–õ–æ–≥–∏–∫—É —Å–æ–∑–¥–∞–Ω–∏—è —é–∑–µ—Ä–∞:** `backend/app/services/auth.py:102-165`

---

### 2. –°–æ–∑–¥–∞–Ω–∏–µ –∑–≤–æ–Ω–∫–∞ (backend/app/api/calls.py)

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:**
- –°–æ–∑–¥–∞–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–π call_id (cryptographically secure)
- –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –∑–≤–æ–Ω–∫–∞ –≤ –ë–î
- –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å—Å—ã–ª–∫—É –¥–ª—è –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
- –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø—É—à-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –¥—Ä—É–≥—É (–¥–ª—è –ø—Ä—è–º—ã—Ö –∑–≤–æ–Ω–∫–æ–≤)

**–í–∞–∂–Ω—ã–µ –¥–µ—Ç–∞–ª–∏:**
```python
# backend/app/models/call.py:21-28
def generate_call_id() -> str:
    """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Ç–æ–∫–µ–Ω –¥–ª–∏–Ω–æ–π 16-20 —Å–∏–º–≤–æ–ª–æ–≤"""
    token = secrets.token_urlsafe(12)  # –ö—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω—ã–π!
    return token[:20]

# –ó–≤–æ–Ω–∫–∏ –∏—Å—Ç–µ–∫–∞—é—Ç —á–µ—Ä–µ–∑ 24 —á–∞—Å–∞:
expires_at = datetime.now(tz=timezone.utc) + timedelta(hours=24)
```

**–ì–¥–µ –ø—Ä–∞–≤–∏—Ç—å:**
- **–í—Ä–µ–º—è –∏—Å—Ç–µ—á–µ–Ω–∏—è –∑–≤–æ–Ω–∫–∞:** `backend/app/api/calls.py:82` (–º–µ–Ω—è–π `hours=24`)
- **–î–ª–∏–Ω—É call_id:** `backend/app/models/call.py:24-28`
- **–õ–æ–≥–∏–∫—É —Å–æ–∑–¥–∞–Ω–∏—è:** `backend/app/api/calls.py:72-110`

---

### 3. WebRTC Signaling (backend/app/api/signaling.py)

**–ß—Ç–æ —ç—Ç–æ:**
WebSocket —Å–µ—Ä–≤–µ—Ä –¥–ª—è –æ–±–º–µ–Ω–∞ SDP offer/answer –∏ ICE –∫–∞–Ω–¥–∏–¥–∞—Ç–∞–º–∏ –º–µ–∂–¥—É —É—á–∞—Å—Ç–Ω–∏–∫–∞–º–∏.

**–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
```
User A                   Server                    User B
  |                         |                         |
  |-- WS Connect ---------->|                         |
  |<- participants_snapshot-|                         |
  |                         |<-- WS Connect ----------|
  |<- user_joined -----------|--- user_joined ------->|
  |-- SDP offer ----------->|                         |
  |                         |--- relay offer -------->|
  |                         |<-- SDP answer ----------|
  |<- relay answer ---------|                         |
  |-- ICE candidate ------->|--- relay ICE ---------->|
  |<----------------------- DIRECT P2P MEDIA --------|
```

**CallRoom (in-memory —Ö—Ä–∞–Ω–∏–ª–∏—â–µ):**
```python
class CallRoom:
    _participants: dict[int, ParticipantConnection]  # user_id -> WebSocket

    async def broadcast(message):
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –≤—Å–µ–º —É—á–∞—Å—Ç–Ω–∏–∫–∞–º (–∫—Ä–æ–º–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è)
```

**‚ö†Ô∏è –í–ê–ñ–ù–û:**
- –ö–∞–∂–¥—ã–π –∑–≤–æ–Ω–æ–∫ = 1 CallRoom
- CallRoom —Å—É—â–µ—Å—Ç–≤—É–µ—Ç —Ç–æ–ª—å–∫–æ –ø–æ–∫–∞ –µ—Å—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∏
- –ü—Ä–∏ –æ—Ç–∫–ª—é—á–µ–Ω–∏–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞ ‚Üí room —É–¥–∞–ª—è–µ—Ç—Å—è

**–ì–¥–µ –ø—Ä–∞–≤–∏—Ç—å:**
- **WebSocket endpoint:** `backend/app/api/signaling.py:186-394`
- **CallRoom –ª–æ–≥–∏–∫–∞:** `backend/app/services/signaling.py:23-127`
- **Broadcast –ª–æ–≥–∏–∫–∞:** `backend/app/services/signaling.py:79-127`

---

### 4. Frontend WebRTC (frontend/src/pages/CallPage.tsx)

**‚ö†Ô∏è –°–ê–ú–´–ô –°–õ–û–ñ–ù–´–ô –§–ê–ô–õ - 1737 –°–¢–†–û–ö!**

**–û—Å–Ω–æ–≤–Ω—ã–µ –æ–±—è–∑–∞–Ω–Ω–æ—Å—Ç–∏:**
1. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ª–æ–∫–∞–ª—å–Ω—ã–º –º–µ–¥–∏–∞-—Å—Ç—Ä–∏–º–æ–º (–º–∏–∫—Ä–æ—Ñ–æ–Ω/–∫–∞–º–µ—Ä–∞)
2. –°–æ–∑–¥–∞–Ω–∏–µ RTCPeerConnection –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞
3. –û–±—Ä–∞–±–æ—Ç–∫–∞ WebSocket —Å–æ–æ–±—â–µ–Ω–∏–π (offer/answer/ICE)
4. –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–Ω—ã—Ö –≤–∏–¥–µ–æ-—Å—Ç—Ä–∏–º–æ–≤
5. UI —Å–æ—Å—Ç–æ—è–Ω–∏—è (–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ/–æ—Ç–∫–ª—é—á–µ–Ω–∏–µ/–æ—à–∏–±–∫–∏)

**–ö–ª—é—á–µ–≤—ã–µ —á–∞—Å—Ç–∏:**

```typescript
// 1. –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ WebSocket
const ws = new WebSocket(
  `${wsUrl}/ws/calls/${callId}`,
  ['token', `token.${token}`]  // –¢–æ–∫–µ–Ω –≤ subprotocol
);

// 2. –°–æ–∑–¥–∞–Ω–∏–µ PeerConnection –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞
const peer = new RTCPeerConnection({ iceServers });
peer.addTrack(localAudioTrack, localStream);  // –î–æ–±–∞–≤–ª—è–µ–º —Å–≤–æ–π –∞—É–¥–∏–æ

// 3. –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ö–æ–¥—è—â–µ–≥–æ offer
peer.setRemoteDescription(message.payload);
const answer = await peer.createAnswer();
await peer.setLocalDescription(answer);
ws.send({ type: 'answer', to_user_id: from_user.id, payload: answer });

// 4. ICE –∫–∞–Ω–¥–∏–¥–∞—Ç—ã
peer.onicecandidate = (event) => {
  if (event.candidate) {
    ws.send({ type: 'ice_candidate', to_user_id: targetUserId, payload: event.candidate });
  }
};

// 5. –ü–æ–ª—É—á–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ —Å—Ç—Ä–∏–º–∞
peer.ontrack = (event) => {
  setParticipants(prev => /* –æ–±–Ω–æ–≤–ª—è–µ–º stream —É—á–∞—Å—Ç–Ω–∏–∫–∞ */);
};
```

**–ì–¥–µ –ø—Ä–∞–≤–∏—Ç—å:**
- **–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–µ–¥–∏–∞:** `frontend/src/pages/CallPage.tsx:350-500`
- **WebSocket –ª–æ–≥–∏–∫–∞:** `frontend/src/pages/CallPage.tsx:1100-1300`
- **Peer connections:** `frontend/src/pages/CallPage.tsx:900-1100`
- **UI —Å–æ—Å—Ç–æ—è–Ω–∏—è:** `frontend/src/pages/CallPage.tsx:1500-1700`

---

### 5. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –¥—Ä—É–∑—å—è (backend/app/api/signaling.py:268-287)

**–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
```python
# –ü—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∫ –∑–≤–æ–Ω–∫—É:
1. –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ—Ö –î–†–£–ì–ò–• —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ —ç—Ç–æ–≥–æ –∑–≤–æ–Ω–∫–∞
2. –°–æ–∑–¥–∞–µ–º –î–í–£–°–¢–û–†–û–ù–ù–ò–ï —Å–≤—è–∑–∏ friend_link:
   - user_id=A, friend_id=B
   - user_id=B, friend_id=A
3. –ï—Å–ª–∏ —Å–≤—è–∑—å —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç ‚Üí –æ–±–Ω–æ–≤–ª—è–µ–º updated_at
```

**–ü–æ—á–µ–º—É –¥–≤—É—Å—Ç–æ—Ä–æ–Ω–Ω–∏–µ:**
```sql
-- –ë—ã—Å—Ç—Ä—ã–π –ø–æ–∏—Å–∫ –¥—Ä—É–∑–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è A:
SELECT * FROM friend_links WHERE user_id = A

-- –ù–ï –Ω—É–∂–µ–Ω JOIN!
-- –ï—Å–ª–∏ –±—ã –±—ã–ª–∞ –æ–¥–Ω–æ—Å—Ç–æ—Ä–æ–Ω–Ω—è—è, –ø—Ä–∏—à–ª–æ—Å—å –±—ã –¥–µ–ª–∞—Ç—å:
SELECT * FROM friend_links WHERE user_id = A OR friend_id = A
```

**–ì–¥–µ –ø—Ä–∞–≤–∏—Ç—å:**
- **–õ–æ–≥–∏–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** `backend/app/api/signaling.py:104-151`
- **–ö–æ–≥–¥–∞ —Å–æ–∑–¥–∞—é—Ç—Å—è:** `backend/app/api/signaling.py:268-287`

---

## üîë –ö–ª—é—á–µ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏

### 1. –°–æ–∑–¥–∞–Ω–∏–µ –∑–≤–æ–Ω–∫–∞
**–§–∞–π–ª:** `backend/app/api/calls.py:72-110`
```
POST /api/calls
Body: { "title": "–ù–∞–∑–≤–∞–Ω–∏–µ", "is_video_enabled": true }
‚Üí –°–æ–∑–¥–∞–µ—Ç Call –≤ –ë–î
‚Üí –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç { "call_id": "abc123", "join_url": "t.me/bot?startapp=abc123" }
```

### 2. –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∫ –∑–≤–æ–Ω–∫—É
**–§–∞–π–ª:** `frontend/src/pages/CallPage.tsx`
```
1. GET /api/calls/{call_id} ‚Üí –ø—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –∑–≤–æ–Ω–æ–∫ –∞–∫—Ç–∏–≤–µ–Ω
2. GET /auth/ws-token ‚Üí –ø–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ –¥–ª—è WS
3. WebSocket ‚Üí /ws/calls/{call_id}
4. –û–±–º–µ–Ω SDP/ICE ‚Üí —É—Å—Ç–∞–Ω–æ–≤–∫–∞ P2P —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
```

### 3. –ó–≤–æ–Ω–æ–∫ –¥—Ä—É–≥—É
**–§–∞–π–ª:** `backend/app/api/calls.py:268-360`
```
POST /api/calls/friend
Body: { "friend_id": 123 }
‚Üí –°–æ–∑–¥–∞–µ—Ç –∑–≤–æ–Ω–æ–∫
‚Üí –î–æ–±–∞–≤–ª—è–µ—Ç —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –≤ –ë–î
‚Üí –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
```

### 4. –ü–æ–∏—Å–∫ –¥—Ä—É–∑–µ–π
**–§–∞–π–ª:** `backend/app/api/friends.py:36-118`
```
GET /api/friends?query=john&limit=50&offset=0
‚Üí –ò—â–µ—Ç –ø–æ username, first_name, last_name (ILIKE)
‚Üí –°–æ—Ä—Ç–∏—Ä—É–µ—Ç –ø–æ updated_at DESC (–Ω–µ–¥–∞–≤–Ω–∏–µ –∑–≤–æ–Ω–∫–∏ –≤—ã—à–µ)
‚Üí –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ —Å –ø–æ—Å–ª–µ–¥–Ω–∏–º –≤—Ä–µ–º–µ–Ω–µ–º –∑–≤–æ–Ω–∫–∞
```

---

## üíæ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

### –°—Ö–µ–º–∞ —Ç–∞–±–ª–∏—Ü

```sql
-- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ Telegram
CREATE TABLE users (
  id SERIAL PRIMARY KEY,
  telegram_user_id BIGINT UNIQUE NOT NULL,  -- ID –∏–∑ Telegram
  username VARCHAR(255),
  first_name VARCHAR(255),
  last_name VARCHAR(255),
  photo_url TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
CREATE INDEX idx_users_telegram_id ON users(telegram_user_id);

-- –ó–≤–æ–Ω–∫–∏
CREATE TABLE calls (
  id SERIAL PRIMARY KEY,
  call_id VARCHAR(20) UNIQUE NOT NULL,  -- –ü—É–±–ª–∏—á–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä
  creator_user_id INT REFERENCES users(id) ON DELETE CASCADE,
  title VARCHAR(255),
  is_video_enabled BOOLEAN DEFAULT false,
  status VARCHAR(20) DEFAULT 'active',  -- active/ended/expired
  created_at TIMESTAMPTZ DEFAULT NOW(),
  expires_at TIMESTAMPTZ  -- –û–±—ã—á–Ω–æ created_at + 24 —á–∞—Å–∞
);
CREATE INDEX idx_calls_call_id ON calls(call_id);
CREATE INDEX idx_calls_creator ON calls(creator_user_id);

-- –£—á–∞—Å—Ç–Ω–∏–∫–∏ –∑–≤–æ–Ω–∫–æ–≤ (–∏—Å—Ç–æ—Ä–∏—è)
CREATE TABLE participants (
  id SERIAL PRIMARY KEY,
  call_id INT REFERENCES calls(id) ON DELETE CASCADE,
  user_id INT REFERENCES users(id) ON DELETE CASCADE,
  joined_at TIMESTAMPTZ DEFAULT NOW(),
  left_at TIMESTAMPTZ,  -- NULL –µ—Å–ª–∏ –µ—â–µ –≤ –∑–≤–æ–Ω–∫–µ
  UNIQUE(call_id, user_id)  -- –û–¥–∏–Ω —é–∑–µ—Ä = –æ–¥–Ω–∞ –∑–∞–ø–∏—Å—å –Ω–∞ –∑–≤–æ–Ω–æ–∫
);
CREATE INDEX idx_participants_call ON participants(call_id);
CREATE INDEX idx_participants_user ON participants(user_id);

-- –î—Ä—É–∑—å—è (–¥–≤—É—Å—Ç–æ—Ä–æ–Ω–Ω—è—è –º–æ–¥–µ–ª—å)
CREATE TABLE friend_links (
  user_id INT REFERENCES users(id) ON DELETE CASCADE,
  friend_id INT REFERENCES users(id) ON DELETE CASCADE,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),  -- –û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∑–≤–æ–Ω–∫–µ
  PRIMARY KEY (user_id, friend_id)
);
CREATE INDEX idx_friend_links_user ON friend_links(user_id);
CREATE INDEX idx_friend_links_updated ON friend_links(user_id, updated_at DESC);

-- –ú–µ—Ç—Ä–∏–∫–∏ –∫–∞—á–µ—Å—Ç–≤–∞ –∑–≤–æ–Ω–∫–æ–≤
CREATE TABLE call_stats (
  id SERIAL PRIMARY KEY,
  call_id VARCHAR(20) REFERENCES calls(call_id) ON DELETE CASCADE,
  user_id INT REFERENCES users(id) ON DELETE CASCADE,
  duration_seconds INT,
  audio_bitrate_kbps FLOAT,
  audio_packets_lost INT,
  audio_jitter_ms FLOAT,
  video_bitrate_kbps FLOAT,
  video_packets_lost INT,
  video_frame_rate FLOAT,
  video_resolution VARCHAR(20),
  rtt_ms FLOAT,  -- Round-trip time
  created_at TIMESTAMPTZ DEFAULT NOW()
);
CREATE INDEX idx_call_stats_call ON call_stats(call_id);
```

### –ú–∏–≥—Ä–∞—Ü–∏–∏ (Alembic)

```bash
# –ü—Ä–∏–º–µ–Ω–∏—Ç—å –≤—Å–µ –º–∏–≥—Ä–∞—Ü–∏–∏
cd backend
alembic upgrade head

# –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –º–∏–≥—Ä–∞—Ü–∏—é
alembic revision --autogenerate -m "–æ–ø–∏—Å–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π"

# –û—Ç–∫–∞—Ç–∏—Ç—å –Ω–∞ –æ–¥–Ω—É –º–∏–≥—Ä–∞—Ü–∏—é –Ω–∞–∑–∞–¥
alembic downgrade -1

# –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ç–µ–∫—É—â—É—é –≤–µ—Ä—Å–∏—é
alembic current
```

**–°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏:**
1. `9044ba1e3377` - Initial schema (users, calls, participants)
2. `66c9d0e14a53` - Timezone-aware datetimes
3. `3c4d5e6f7g8h` - Friend links bidirectional model
4. `a1b2c3d4e5f6` - Photo URL support
5. `e5f6g7h8i9j0` - Call stats table
6. `f1a2b3c4d5e6` - Performance indexes
7. `g1h2i3j4k5l6` - Cleanup invalid friend links

---

## üåê API Endpoints

### –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è

#### POST /auth/telegram
**–û–ø–∏—Å–∞–Ω–∏–µ:** –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ Telegram Mini App
**Rate limit:** 5 req/min
**Body:**
```json
{
  "initData": "query_id=...&user={...}&auth_date=...&hash=..."
}
```
**Response:**
```json
{
  "user": {
    "id": 1,
    "telegram_user_id": 123456789,
    "username": "johndoe",
    "first_name": "John",
    "last_name": "Doe"
  },
  "access_token": "eyJ...",
  "expires_in": 2592000,
  "token_type": "bearer"
}
```
**Cookie:** –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç `access_token` (httpOnly, Secure, SameSite=none)

#### GET /auth/ws-token
**–û–ø–∏—Å–∞–Ω–∏–µ:** –ü–æ–ª—É—á–∏—Ç—å —Ç–æ–∫–µ–Ω –¥–ª—è WebSocket (–∏–∑ httpOnly cookie)
**Auth:** Required
**Response:**
```json
{
  "token": "eyJ..."
}
```

---

### –ó–≤–æ–Ω–∫–∏

#### POST /api/calls
**–û–ø–∏—Å–∞–Ω–∏–µ:** –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –∑–≤–æ–Ω–æ–∫
**Rate limit:** 10 req/min
**Auth:** Required
**Body:**
```json
{
  "title": "Team sync",
  "is_video_enabled": true
}
```
**Response:**
```json
{
  "call_id": "Abc123XyZ456",
  "title": "Team sync",
  "is_video_enabled": true,
  "status": "active",
  "created_at": "2025-12-13T10:30:00Z",
  "expires_at": "2025-12-14T10:30:00Z",
  "join_url": "https://t.me/your_bot?startapp=Abc123XyZ456"
}
```

#### GET /api/calls/{call_id}
**–û–ø–∏—Å–∞–Ω–∏–µ:** –ü–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∑–≤–æ–Ω–∫–µ
**Auth:** Required
**Response:** –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ POST /api/calls
**Errors:**
- 404 - –ó–≤–æ–Ω–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω / –∏—Å—Ç–µ–∫ / –∑–∞–≤–µ—Ä—à–µ–Ω

#### POST /api/calls/{call_id}/end
**–û–ø–∏—Å–∞–Ω–∏–µ:** –ó–∞–≤–µ—Ä—à–∏—Ç—å –∑–≤–æ–Ω–æ–∫ (—Ç–æ–ª—å–∫–æ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä!)
**Auth:** Required
**Response:** –û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–≤–æ–Ω–∫–µ
**Errors:**
- 403 - –¢–æ–ª—å–∫–æ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä –º–æ–∂–µ—Ç –∑–∞–≤–µ—Ä—à–∏—Ç—å –∑–≤–æ–Ω–æ–∫
- 400 - –ó–≤–æ–Ω–æ–∫ —É–∂–µ –∑–∞–≤–µ—Ä—à–µ–Ω

#### POST /api/calls/join_by_code
**–û–ø–∏—Å–∞–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–¥ –∑–≤–æ–Ω–∫–∞ –ø–µ—Ä–µ–¥ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ–º
**Auth:** Required
**Body:**
```json
{
  "call_code": "Abc123XyZ456"
}
```
**Response:** –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–≤–æ–Ω–∫–µ (–∫–∞–∫ GET /api/calls/{call_id})

#### POST /api/calls/friend
**–û–ø–∏—Å–∞–Ω–∏–µ:** –°–æ–∑–¥–∞—Ç—å –∑–≤–æ–Ω–æ–∫ –∏ –ø–æ–∑–≤–æ–Ω–∏—Ç—å –¥—Ä—É–≥—É
**Rate limit:** 10 req/min
**Auth:** Required
**Body:**
```json
{
  "friend_id": 42
}
```
**Response:** –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–æ–∑–¥–∞–Ω–Ω–æ–º –∑–≤–æ–Ω–∫–µ
**Side effects:**
- –°–æ–∑–¥–∞–µ—Ç Participant –∑–∞–ø–∏—Å–∏ –¥–ª—è –æ–±–æ–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç Telegram push —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –¥—Ä—É–≥—É

---

### –î—Ä—É–∑—å—è

#### GET /api/friends
**–û–ø–∏—Å–∞–Ω–∏–µ:** –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –¥—Ä—É–∑–µ–π —Å –ø–æ–∏—Å–∫–æ–º
**Auth:** Required
**Query params:**
- `query` (optional) - –ü–æ–∏—Å–∫ –ø–æ username/first_name/last_name
- `limit` (default: 50, max: 100)
- `offset` (default: 0)
**Response:**
```json
{
  "friends": [
    {
      "id": 42,
      "telegram_user_id": 987654321,
      "username": "alice",
      "first_name": "Alice",
      "last_name": "Smith",
      "photo_url": "https://...",
      "last_call_at": "2025-12-10T15:20:00Z"
    }
  ],
  "total": 15
}
```

#### POST /api/friends/delete
**–û–ø–∏—Å–∞–Ω–∏–µ:** –£–¥–∞–ª–∏—Ç—å –¥—Ä—É–≥–∞ –∏–∑ —Å–ø–∏—Å–∫–∞
**Auth:** Required
**Body:**
```json
{
  "friend_id": 42
}
```
**Response:**
```json
{
  "message": "Friend deleted successfully"
}
```

---

### WebRTC Config

#### GET /api/config/webrtc
**–û–ø–∏—Å–∞–Ω–∏–µ:** –ü–æ–ª—É—á–∏—Ç—å STUN/TURN —Å–µ—Ä–≤–µ—Ä—ã –¥–ª—è WebRTC
**Auth:** Required
**Response:**
```json
{
  "ice_servers": [
    {
      "urls": "stun:stun.l.google.com:19302"
    },
    {
      "urls": "turns:turn.example.com:5349?transport=tcp",
      "username": "user",
      "credential": "pass"
    }
  ]
}
```

---

### WebSocket

#### WS /ws/calls/{call_id}
**–û–ø–∏—Å–∞–Ω–∏–µ:** WebSocket –¥–ª—è —Å–∏–≥–Ω–∞–ª–∏–∑–∞—Ü–∏–∏ WebRTC
**Auth:** –¢–æ–∫–µ–Ω –≤ `Sec-WebSocket-Protocol: token.{jwt}`

**–í—Ö–æ–¥—è—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è (–æ—Ç –∫–ª–∏–µ–Ω—Ç–∞):**
```json
// Offer (–∏–Ω–∏—Ü–∏–∞—Ç–æ—Ä —Å–æ–∑–¥–∞–µ—Ç offer)
{
  "type": "offer",
  "to_user_id": 42,
  "payload": { "type": "offer", "sdp": "v=0..." }
}

// Answer (–ø–æ–ª—É—á–∞—Ç–µ–ª—å –æ—Ç–≤–µ—á–∞–µ—Ç)
{
  "type": "answer",
  "to_user_id": 123,
  "payload": { "type": "answer", "sdp": "v=0..." }
}

// ICE candidate
{
  "type": "ice_candidate",
  "to_user_id": 42,
  "payload": { "candidate": "...", "sdpMid": "0", ... }
}
```

**–ò—Å—Ö–æ–¥—è—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è (–æ—Ç —Å–µ—Ä–≤–µ—Ä–∞):**
```json
// –°–Ω–∏–º–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏
{
  "type": "participants_snapshot",
  "participants": [
    { "id": 42, "username": "alice", ... }
  ]
}

// –ù–æ–≤—ã–π —É—á–∞—Å—Ç–Ω–∏–∫ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è
{
  "type": "user_joined",
  "user": { "id": 99, "username": "bob", ... }
}

// –£—á–∞—Å—Ç–Ω–∏–∫ –æ—Ç–∫–ª—é—á–∏–ª—Å—è
{
  "type": "user_left",
  "user": { "id": 42, ... }
}

// –†–µ–ª–µ–π offer/answer/ICE
{
  "type": "offer",  // –∏–ª–∏ "answer", "ice_candidate"
  "from_user": { "id": 42, ... },
  "payload": { ... }
}

// –ó–≤–æ–Ω–æ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω –æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä–æ–º
{
  "type": "call_ended",
  "reason": "ended"  // –∏–ª–∏ "expired"
}

// –û—à–∏–±–∫–∞
{
  "type": "error",
  "detail": "Target user is offline"
}
```

---

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –º–µ—Ä—ã

1. **–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è:**
   - ‚úÖ HMAC-SHA256 –≤–∞–ª–∏–¥–∞—Ü–∏—è Telegram initData
   - ‚úÖ JWT —Ç–æ–∫–µ–Ω—ã (HS256)
   - ‚úÖ httpOnly cookies (–∑–∞—â–∏—Ç–∞ –æ—Ç XSS)
   - ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ auth_date (–Ω–µ —Å—Ç–∞—Ä—à–µ 24 —á–∞—Å–æ–≤)

2. **Rate Limiting:**
   - ‚úÖ –ì–ª–æ–±–∞–ª—å–Ω—ã–π: 100 req/min
   - ‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è: 5 req/min
   - ‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ –∑–≤–æ–Ω–∫–∞: 10 req/min

3. **CORS:**
   - ‚úÖ –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–µ allowed origins
   - ‚úÖ Credentials: true (–¥–ª—è cookies)
   - ‚úÖ Preflight cache: 10 –º–∏–Ω—É—Ç

4. **HTTPS/WSS:**
   - ‚úÖ Traefik –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π redirect HTTP ‚Üí HTTPS
   - ‚úÖ WebSocket —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ WSS
   - ‚úÖ TLS —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã

5. **Database:**
   - ‚úÖ SQL Injection –∑–∞—â–∏—Ç–∞ (SQLAlchemy ORM)
   - ‚úÖ Async I/O (–Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç —Å–µ—Ä–≤–µ—Ä)
   - ‚úÖ ON DELETE CASCADE (–∞–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∞)

### ‚ö†Ô∏è –¢—Ä–µ–±—É—é—Ç –≤–Ω–∏–º–∞–Ω–∏—è (—Å–º. SECURITY_AUDIT_REPORT.md)

- ‚ùå –ù–µ—Ç –ª–∏–º–∏—Ç–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –∫–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü–∏–∏
- ‚ùå –ù–µ—Ç rate limiting –Ω–∞ WebSocket
- ‚ùå Memory leak –≤ CallRoomManager
- ‚ö†Ô∏è –¢–æ–∫–µ–Ω –≤ query params (fallback)
- ‚ö†Ô∏è –ù–µ—Ç –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Ä–∞–∑–º–µ—Ä–∞ WS —Å–æ–æ–±—â–µ–Ω–∏–π
- ‚ö†Ô∏è –ù–µ—Ç CSP headers
- ‚ö†Ô∏è –ù–µ—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –∑–≤–æ–Ω–∫–∞

---

## üõ†Ô∏è –ì–¥–µ —á—Ç–æ –ø—Ä–∞–≤–∏—Ç—å

### –ò–∑–º–µ–Ω–∏—Ç—å –≤—Ä–µ–º—è –∂–∏–∑–Ω–∏ JWT —Ç–æ–∫–µ–Ω–∞
```python
# backend/app/config/settings.py:30-34
access_token_expire_minutes: int = Field(
    60 * 24 * 30,  # ‚Üê –ú–µ–Ω—è–π –∑–¥–µ—Å—å (—Å–µ–π—á–∞—Å 30 –¥–Ω–µ–π)
    validation_alias="ACCESS_TOKEN_EXPIRE_MINUTES",
)
```

### –ò–∑–º–µ–Ω–∏—Ç—å –≤—Ä–µ–º—è –∏—Å—Ç–µ—á–µ–Ω–∏—è –∑–≤–æ–Ω–∫–∞
```python
# backend/app/api/calls.py:82
expires_at = datetime.now(tz=timezone.utc) + timedelta(hours=24)  # ‚Üê –ú–µ–Ω—è–π hours=24
```

### –î–æ–±–∞–≤–∏—Ç—å –ª–∏–º–∏—Ç —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
```python
# backend/app/services/signaling.py:37
MAX_PARTICIPANTS = 10  # –î–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω—Å—Ç–∞–Ω—Ç—É

async def add_participant(self, user_id: int, websocket: WebSocket, user: dict[str, Any]) -> None:
    async with self._lock:
        if len(self._participants) >= MAX_PARTICIPANTS:  # –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É
            raise HTTPException(429, "Call is full")
        # ...
```

### –ò–∑–º–µ–Ω–∏—Ç—å rate limits
```python
# backend/app/main.py:60
limiter = Limiter(key_func=get_remote_address, default_limits=["100/minute"])  # –ì–ª–æ–±–∞–ª—å–Ω—ã–π

# backend/app/api/auth.py:102
@limiter.limit("5/minute")  # –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è

# backend/app/api/calls.py:73, 269
@limiter.limit("10/minute")  # –°–æ–∑–¥–∞–Ω–∏–µ –∑–≤–æ–Ω–∫–∞
```

### –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π —è–∑—ã–∫
```bash
# 1. –°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª
frontend/src/i18n/locales/de.json  # –ù–µ–º–µ—Ü–∫–∏–π

# 2. –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∏–∑ en.json –∏–ª–∏ ru.json

# 3. –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –≤ i18n
# frontend/src/i18n/i18n.ts
import de from './locales/de.json';

resources: {
  en: { translation: en },
  ru: { translation: ru },
  de: { translation: de },  // ‚Üê –î–æ–±–∞–≤–∏—Ç—å
}
```

### –ò–∑–º–µ–Ω–∏—Ç—å UI —Ü–≤–µ—Ç–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
```typescript
// frontend/src/pages/CallPage.tsx:51-58
const PARTICIPANT_COLORS = [
  "linear-gradient(135deg, #1d4ed8, #60a5fa)",  // –°–∏–Ω–∏–π
  "linear-gradient(135deg, #0ea5e9, #38bdf8)",  // –ì–æ–ª—É–±–æ–π
  // –î–æ–±–∞–≤—å —Å–≤–æ–∏ —Ü–≤–µ—Ç–∞...
];
```

### –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π API endpoint
```python
# 1. –°–æ–∑–¥–∞—Ç—å –≤ backend/app/api/
# backend/app/api/my_feature.py
from fastapi import APIRouter
router = APIRouter(prefix="/api/my-feature", tags=["MyFeature"])

@router.get("/")
async def get_data():
    return {"status": "ok"}

# 2. –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –≤ backend/app/api/__init__.py
from app.api import my_feature

def get_api_router():
    router = APIRouter()
    router.include_router(my_feature.router)
    return router
```

---

## üöÄ –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ

### –õ–æ–∫–∞–ª—å–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞

```bash
# 1. Backend
cd backend
python -m venv venv
source venv/bin/activate  # Windows: venv\Scripts\activate
pip install -r requirements.txt
cp .env.example .env
# –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å .env (BOT_TOKEN, DATABASE_URL, SECRET_KEY)
alembic upgrade head
uvicorn app.main:app --reload

# 2. Frontend
cd frontend
npm install
cp .env.example .env
# –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å VITE_API_BASE_URL
npm run dev
```

### Production (Docker Compose)

```bash
# 1. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞
cd infra
cp .env.example .env
# –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å .env (–≤—Å–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ!)

cd ../backend
cp .env.example .env
# –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å backend/.env

# 2. TLS —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã
# Traefik (HTTPS –¥–ª—è API/Frontend)
mkdir -p infra/traefik/certs
# –ü–æ–ª–æ–∂–∏—Ç—å tls.crt –∏ tls.key

# TURN —Å–µ—Ä–≤–µ—Ä
mkdir -p infra/turn/certs
# –ü–æ–ª–æ–∂–∏—Ç—å turn.crt –∏ turn.key

# 3. –ó–∞–ø—É—Å–∫
cd infra
docker-compose up -d

# 4. –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏
docker-compose exec backend alembic upgrade head

# 5. –ü—Ä–æ–≤–µ—Ä–∫–∞
docker-compose ps
docker-compose logs -f backend
```

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è (Production)

**backend/.env:**
```bash
# Database
DATABASE_URL=postgresql+asyncpg://user:password@postgres:5432/telcall

# Telegram
BOT_TOKEN=123456:ABCdefGHI...
BOT_USERNAME=your_bot

# Security
SECRET_KEY=–≥–µ–Ω–µ—Ä–∏—Ä—É–π_—á–µ—Ä–µ–∑_openssl_rand_-hex_32
ACCESS_TOKEN_EXPIRE_MINUTES=43200  # 30 –¥–Ω–µ–π

# WebRTC
STUN_SERVERS=stun:stun.l.google.com:19302
TURN_SERVERS=turns:turn.example.com:5349?transport=tcp
TURN_USERNAME=user
TURN_PASSWORD=secure_password

# CORS
CORS_ALLOW_ORIGINS=https://callwith.ru,https://www.callwith.ru

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏
DEBUG=false
```

**infra/.env:**
```bash
# –î–æ–º–µ–Ω—ã
BACKEND_HOST=api.callwith.ru
FRONTEND_HOST=callwith.ru

# TURN
TURN_REALM=callwith.ru
TURN_SERVER_NAME=turn.callwith.ru
TURN_USERNAME=user
TURN_PASSWORD=secure_password
```

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

```bash
# –õ–æ–≥–∏
docker-compose logs -f backend
docker-compose logs -f frontend
docker-compose logs -f turn

# –ú–µ—Ç—Ä–∏–∫–∏
docker stats

# Health check
curl https://api.callwith.ru/health
```

---

## üìà –ú–µ—Ç—Ä–∏–∫–∏ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ (TODO)

### –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–æ–±–∞–≤–∏—Ç—å:

1. **Prometheus + Grafana**
   - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–≤–æ–Ω–∫–æ–≤
   - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
   - WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
   - Database connection pool usage
   - HTTP request rate
   - Error rate

2. **Sentry** (error tracking)
   - –û—à–∏–±–∫–∏ backend
   - –û—à–∏–±–∫–∏ frontend
   - WebRTC connection failures

3. **–ê–ª–µ—Ä—Ç—ã**
   - CPU/Memory > 80%
   - Active calls > 1000
   - Database connection pool exhausted
   - TURN server down

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

```bash
# Backend tests
cd backend
pytest
pytest --cov=app tests/  # –° –ø–æ–∫—Ä—ã—Ç–∏–µ–º

# Frontend tests
cd frontend
npm run test
npm run test:coverage
```

---

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã

- **WebRTC:** https://webrtc.org/
- **Telegram Mini Apps:** https://core.telegram.org/bots/webapps
- **FastAPI:** https://fastapi.tiangolo.com/
- **React:** https://react.dev/
- **Alembic:** https://alembic.sqlalchemy.org/

---

**–°–æ–∑–¥–∞–Ω–æ:** 2025-12-13
**–í–µ—Ä—Å–∏—è:** 2.0
**–ê–≤—Ç–æ—Ä:** Claude Code Agent

> üí° **–°–æ–≤–µ—Ç:** –ù–∞—á–Ω–∏ —Å —á—Ç–µ–Ω–∏—è SECURITY_AUDIT_REPORT.md –¥–ª—è –ø–æ–Ω–∏–º–∞–Ω–∏—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º!
