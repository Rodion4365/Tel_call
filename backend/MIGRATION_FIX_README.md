# üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã —Å –º–∏–≥—Ä–∞—Ü–∏—è–º–∏ Alembic

## üß† –°—É—Ç—å –ø—Ä–æ–±–ª–µ–º—ã

–ü—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –∑–∞–ø—É—Å—Ç–∏—Ç—å `alembic upgrade head` –≤–æ–∑–Ω–∏–∫–∞–µ—Ç –æ—à–∏–±–∫–∞:
```
sqlalchemy.exc.NoSuchTableError: users
```

**–ü—Ä–∏—á–∏–Ω–∞**: –í –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π stamp –º–∏–≥—Ä–∞—Ü–∏–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `c7a3d9e12f8b`), –Ω–æ —Ç–∞–±–ª–∏—Ü–∞ `users` –Ω–µ —Å–æ–∑–¥–∞–Ω–∞, –ø–æ—Ç–æ–º—É —á—Ç–æ –Ω–∞—á–∞–ª—å–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏—è `9044ba1e3377` –Ω–µ –±—ã–ª–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∞.

## ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –º–∏–≥—Ä–∞—Ü–∏–π

```
9044ba1e3377 ‚Üí Initial migration (—Å–æ–∑–¥–∞–µ—Ç users, calls, participants)
fb958ba03c93 ‚Üí Add call_stats table
c7a3d9e12f8b ‚Üí Change users datetime to timezone aware
d1e2f3a4b5c6 ‚Üí Add photo_url to users
e5f6a7b8c9d0 ‚Üí Add friend_links table
f1a2b3c4d5e6 ‚Üí Add performance indexes
a1b2c3d4e5f6 ‚Üí Cleanup invalid friend links
g1h2i3j4k5l6 ‚Üí Migrate to bidirectional friend links
```

## üéØ –†–µ—à–µ–Ω–∏–µ

### –í–ê–†–ò–ê–ù–¢ 1: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Å–∫—Ä–∏–ø—Ç (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–ª—è –ø—É—Å—Ç–æ–π –ë–î)

**‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï**: –≠—Ç–æ—Ç –º–µ—Ç–æ–¥ —É–¥–∞–ª–∏—Ç –≤—Å–µ –¥–∞–Ω–Ω—ã–µ! –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –¢–û–õ–¨–ö–û –Ω–∞ –Ω–æ–≤–æ–º —Å–µ—Ä–≤–µ—Ä–µ!

```bash
cd backend
chmod +x fix_migrations.sh
./fix_migrations.sh
```

–°–∫—Ä–∏–ø—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:
1. –°–±—Ä–æ—Å–∏—Ç —Ç–∞–±–ª–∏—Ü—É `alembic_version`
2. –£–¥–∞–ª–∏—Ç –≤—Å–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ç–∞–±–ª–∏—Ü—ã
3. –ü—Ä–∏–º–µ–Ω–∏—Ç –≤—Å–µ –º–∏–≥—Ä–∞—Ü–∏–∏ —Å —Å–∞–º–æ–≥–æ –Ω–∞—á–∞–ª–∞

### –í–ê–†–ò–ê–ù–¢ 2: –†—É—á–Ω–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ (–µ—Å–ª–∏ –Ω—É–∂–µ–Ω –∫–æ–Ω—Ç—Ä–æ–ª—å)

#### –®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç–µ–∫—É—â–∏–π stamp

```bash
cd backend
alembic current
```

#### –®–∞–≥ 2: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, –∫–∞–∫–∏–µ —Ç–∞–±–ª–∏—Ü—ã —Å—É—â–µ—Å—Ç–≤—É—é—Ç

```bash
# –í PostgreSQL:
docker compose exec postgres psql -U app -d app -c "\dt"
```

#### –®–∞–≥ 3–∞: –ï—Å–ª–∏ –±–∞–∑–∞ –ü–£–°–¢–ê–Ø (–Ω–µ—Ç —Ç–∞–±–ª–∏—Ü users, calls –∏ —Ç.–¥.)

```bash
# –°–±—Ä–æ—Å—å—Ç–µ stamp –Ω–∞ –Ω–∞—á–∞–ª–æ
alembic downgrade base

# –ò–ª–∏ —É–¥–∞–ª–∏—Ç–µ —Ç–∞–±–ª–∏—Ü—É alembic_version
docker compose exec postgres psql -U app -d app -c "DROP TABLE IF EXISTS alembic_version;"

# –ü—Ä–∏–º–µ–Ω–∏—Ç–µ –≤—Å–µ –º–∏–≥—Ä–∞—Ü–∏–∏
alembic upgrade head
```

#### –®–∞–≥ 3–±: –ï—Å–ª–∏ –±–∞–∑–∞ –ù–ï –ü–£–°–¢–ê–Ø (–µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ)

```bash
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, –∫–∞–∫–∏–µ —Ç–∞–±–ª–∏—Ü—ã —Å—É—â–µ—Å—Ç–≤—É—é—Ç
docker compose exec postgres psql -U app -d app -c "\dt"

# –ï—Å–ª–∏ —Ç–∞–±–ª–∏—Ü—ã users, calls, participants —Å—É—â–µ—Å—Ç–≤—É—é—Ç:
alembic stamp 9044ba1e3377

# –ó–∞—Ç–µ–º –ø—Ä–∏–º–µ–Ω–∏—Ç–µ –æ—Å—Ç–∞–≤—à–∏–µ—Å—è –º–∏–≥—Ä–∞—Ü–∏–∏
alembic upgrade head
```

## üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞

–ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–π –ø—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç–∞–±–ª–∏—Ü—ã:

```bash
docker compose exec postgres psql -U app -d app -c "\dt"
```

–î–æ–ª–∂–Ω—ã –±—ã—Ç—å —Å–æ–∑–¥–∞–Ω—ã:
- ‚úÖ `users`
- ‚úÖ `calls`
- ‚úÖ `participants`
- ‚úÖ `call_stats`
- ‚úÖ `friend_links`
- ‚úÖ `alembic_version`

## üìù –ü—Ä–∏–º–µ—á–∞–Ω–∏—è

- –í—Å–µ –º–∏–≥—Ä–∞—Ü–∏–∏ —É–∂–µ –∏–º–µ—é—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
- –ù–∞—á–∞–ª—å–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏—è `9044ba1e3377` —É–∂–µ —Å–æ–∑–¥–∞–µ—Ç —Ç–∞–±–ª–∏—Ü—É `users`
- –ù–µ –Ω—É–∂–Ω–æ —Å–æ–∑–¥–∞–≤–∞—Ç—å –Ω–æ–≤—ã–µ –º–∏–≥—Ä–∞—Ü–∏–∏
- –ü—Ä–æ–±–ª–µ–º–∞ –±—ã–ª–∞ —Ç–æ–ª—å–∫–æ –≤ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–º stamp

## üÜò –ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è `DATABASE_URL` –≤ `backend/.env`
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ PostgreSQL –∑–∞–ø—É—â–µ–Ω –∏ –¥–æ—Å—Ç—É–ø–µ–Ω
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: `docker compose logs backend`
4. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ë–î –µ—Å—Ç—å –ø—Ä–∞–≤–∞ –Ω–∞ —Å–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è

- –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è Alembic: https://alembic.sqlalchemy.org/
- –ú–∏–≥—Ä–∞—Ü–∏–∏ –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤: `backend/alembic/versions/`
- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Alembic: `backend/alembic.ini` –∏ `backend/alembic/env.py`
