#!/bin/bash
# –ü–æ–ª–Ω—ã–π —Å–±—Ä–æ—Å –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π —Å –Ω—É–ª—è
# –†–∞–±–æ—Ç–∞–µ—Ç —á–µ—Ä–µ–∑ Docker Compose

set -e

echo "üóëÔ∏è  –ü–û–õ–ù–´–ô –°–ë–†–û–° –ë–ê–ó–´ –î–ê–ù–ù–´–•"
echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
echo ""
echo "‚ö†Ô∏è  –í–ù–ò–ú–ê–ù–ò–ï: –í—Å–µ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –£–î–ê–õ–ï–ù–´!"
echo "   - –í—Å–µ —Ç–∞–±–ª–∏—Ü—ã –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã"
echo "   - –ò—Å—Ç–æ—Ä–∏—è –º–∏–≥—Ä–∞—Ü–∏–π –±—É–¥–µ—Ç —Å–±—Ä–æ—à–µ–Ω–∞"
echo "   - –í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏, –∑–≤–æ–Ω–∫–∏, —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±—É–¥—É—Ç –ø–æ—Ç–µ—Ä—è–Ω—ã"
echo ""
read -p "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å? –í–≤–µ–¥–∏—Ç–µ 'yes' –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è: " confirm

if [ "$confirm" != "yes" ]; then
    echo "‚ùå –û—Ç–º–µ–Ω–µ–Ω–æ"
    exit 0
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –Ω–∞—Ö–æ–¥–∏–º—Å—è –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
if [ ! -f "reset_database.sh" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: –∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç –∏–∑ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ backend/"
    exit 1
fi

# –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é infra –¥–ª—è docker compose –∫–æ–º–∞–Ω–¥
cd ../infra

echo ""
echo "1Ô∏è‚É£  –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ PostgreSQL –∑–∞–ø—É—â–µ–Ω..."
if ! docker compose ps postgres | grep -q "Up"; then
    echo "   PostgreSQL –Ω–µ –∑–∞–ø—É—â–µ–Ω. –ó–∞–ø—É—Å–∫–∞—é..."
    docker compose up -d postgres
    echo "   –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞ PostgreSQL (10 —Å–µ–∫—É–Ω–¥)..."
    sleep 10
else
    echo "   ‚úÖ PostgreSQL –∑–∞–ø—É—â–µ–Ω"
fi

echo ""
echo "2Ô∏è‚É£  –£–¥–∞–ª–µ–Ω–∏–µ –≤—Å–µ—Ö —Ç–∞–±–ª–∏—Ü..."
docker compose exec -T postgres psql -U app -d app << 'SQL'
DO $$
DECLARE
    r RECORD;
BEGIN
    -- –£–¥–∞–ª—è–µ–º –≤—Å–µ —Ç–∞–±–ª–∏—Ü—ã
    FOR r IN (SELECT tablename FROM pg_tables WHERE schemaname = 'public') LOOP
        EXECUTE 'DROP TABLE IF EXISTS ' || quote_ident(r.tablename) || ' CASCADE';
        RAISE NOTICE '–£–¥–∞–ª–µ–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞: %', r.tablename;
    END LOOP;
END $$;
SQL

if [ $? -eq 0 ]; then
    echo "   ‚úÖ –í—Å–µ —Ç–∞–±–ª–∏—Ü—ã —É–¥–∞–ª–µ–Ω—ã"
else
    echo "   ‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ç–∞–±–ª–∏—Ü"
    exit 1
fi

echo ""
echo "3Ô∏è‚É£  –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –≤—Å–µ—Ö –º–∏–≥—Ä–∞—Ü–∏–π..."
docker compose exec -T backend alembic upgrade head

if [ $? -eq 0 ]; then
    echo "   ‚úÖ –ú–∏–≥—Ä–∞—Ü–∏–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ"
else
    echo "   ‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–∏ –º–∏–≥—Ä–∞—Ü–∏–π"
    exit 1
fi

echo ""
echo "4Ô∏è‚É£  –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü..."
docker compose exec -T postgres psql -U app -d app -c "\dt"

echo ""
echo "5Ô∏è‚É£  –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–µ—Ä—Å–∏–∏ –º–∏–≥—Ä–∞—Ü–∏–π..."
docker compose exec -T backend alembic current

echo ""
echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
echo "‚úÖ –ì–û–¢–û–í–û! –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —Å–±—Ä–æ—à–µ–Ω–∞ –∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞ —Å –Ω—É–ª—è"
echo ""
echo "üìã –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:"
echo "   1. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –±—ç–∫–µ–Ω–¥: docker compose restart backend"
echo "   2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: docker compose logs backend --tail=50"
echo ""
