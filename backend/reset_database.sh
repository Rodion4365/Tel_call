#!/bin/bash
# ะะพะปะฝัะน ัะฑัะพั ะฑะฐะทั ะดะฐะฝะฝัั ะธ ัะพะทะดะฐะฝะธะต ัะฐะฑะปะธั ั ะฝัะปั
# ะัะฟะพะปัะทัะตั SQLAlchemy Base.metadata ะฒะผะตััะพ ะผะธะณัะฐัะธะน

set -e

echo "๐๏ธ  ะะะะะซะ ะกะะะะก ะะะะซ ะะะะะซะฅ"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""
echo "โ๏ธ  ะะะะะะะะ: ะัะต ะดะฐะฝะฝัะต ะฑัะดัั ะฃะะะะะะซ!"
echo "   - ะัะต ัะฐะฑะปะธัั ะฑัะดัั ัะดะฐะปะตะฝั"
echo "   - ะัะต ะฟะพะปัะทะพะฒะฐัะตะปะธ, ะทะฒะพะฝะบะธ, ััะฐัะธััะธะบะฐ ะฑัะดัั ะฟะพัะตััะฝั"
echo ""
read -p "ะัะพะดะพะปะถะธัั? ะะฒะตะดะธัะต 'yes' ะดะปั ะฟะพะดัะฒะตัะถะดะตะฝะธั: " confirm

if [ "$confirm" != "yes" ]; then
    echo "โ ะัะผะตะฝะตะฝะพ"
    exit 0
fi

# ะัะพะฒะตััะตะผ, ััะพ ะฝะฐัะพะดะธะผัั ะฒ ะฟัะฐะฒะธะปัะฝะพะน ะดะธัะตะบัะพัะธะธ
if [ ! -f "reset_database.sh" ]; then
    echo "โ ะัะธะฑะบะฐ: ะทะฐะฟัััะธัะต ัะบัะธะฟั ะธะท ะดะธัะตะบัะพัะธะธ backend/"
    exit 1
fi

# ะะตัะตัะพะดะธะผ ะฒ ะดะธัะตะบัะพัะธั infra ะดะปั docker compose ะบะพะผะฐะฝะด
cd ../infra

echo ""
echo "1๏ธโฃ  ะัะพะฒะตัะบะฐ, ััะพ PostgreSQL ะทะฐะฟััะตะฝ..."
if ! docker compose ps postgres | grep -q "Up"; then
    echo "   PostgreSQL ะฝะต ะทะฐะฟััะตะฝ. ะะฐะฟััะบะฐั..."
    docker compose up -d postgres
    echo "   ะะถะธะดะฐะฝะธะต ะทะฐะฟััะบะฐ PostgreSQL (10 ัะตะบัะฝะด)..."
    sleep 10
else
    echo "   โ PostgreSQL ะทะฐะฟััะตะฝ"
fi

echo ""
echo "2๏ธโฃ  ะฃะดะฐะปะตะฝะธะต ะธ ัะพะทะดะฐะฝะธะต ัะฐะฑะปะธั ัะตัะตะท SQLAlchemy..."

docker compose run --rm backend python3 -c "
import asyncio
from app.config.database import Base, engine

async def reset_database():
    print('   ะฃะดะฐะปะตะฝะธะต ะฒัะตั ัะฐะฑะปะธั...')
    async with engine.begin() as conn:
        await conn.run_sync(Base.metadata.drop_all)
    print('   โ ะขะฐะฑะปะธัั ัะดะฐะปะตะฝั')

    print('   ะกะพะทะดะฐะฝะธะต ะฒัะตั ัะฐะฑะปะธั...')
    async with engine.begin() as conn:
        await conn.run_sync(Base.metadata.create_all)
    print('   โ ะขะฐะฑะปะธัั ัะพะทะดะฐะฝั')

asyncio.run(reset_database())
"

if [ $? -eq 0 ]; then
    echo "   โ ะะฐะทะฐ ะดะฐะฝะฝัั ัะฑัะพัะตะฝะฐ ััะฟะตัะฝะพ"
else
    echo "   โ ะัะธะฑะบะฐ ะฟัะธ ัะฑัะพัะต ะฑะฐะทั ะดะฐะฝะฝัั"
    exit 1
fi

echo ""
echo "3๏ธโฃ  ะัะพะฒะตัะบะฐ ัะพะทะดะฐะฝะฝัั ัะฐะฑะปะธั..."
docker compose exec -T postgres psql -U app -d app -c "\dt"

echo ""
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "โ ะะะขะะะ! ะะฐะทะฐ ะดะฐะฝะฝัั ัะฑัะพัะตะฝะฐ ะธ ัะฐะฑะปะธัั ัะพะทะดะฐะฝั"
echo ""
echo "๐ ะกะปะตะดัััะธะต ัะฐะณะธ:"
echo "   1. ะะตัะตะทะฐะฟัััะธัะต ะฑัะบะตะฝะด: docker compose restart backend"
echo "   2. ะัะพะฒะตัััะต ะปะพะณะธ: docker compose logs backend --tail=50"
echo ""
